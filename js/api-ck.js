(function(e){e(function(){function s(){function b(e){e=e.substr(0,e.length-2);pxNum=parseInt(e);return pxNum}var t=0,n=0,i=b(e(".selectArea").css("left")),s=b(e(".selectArea").css("top")),o=0,u=0,a=0,f=0,l=0,c=0,h=1,p=1,d=e("#drag")[0],v=e("#imgEditor #canvas")[0];v.width=e(".selectArea").width();v.height=e(".selectArea").height();var m=v.getContext("2d"),g=new Image,y=0;this.reset=function(){t=g.width/y/2-i;n=g.height/y/2-s;a=0;f=0;l=0;c=0;h=1;p=1;d.style.webkitTransform="translate3d("+l+"px,"+c+"px, 0px) "+"scale("+p+")"};this.show=function(r){this.reset();g.src=r;g.onload=function(){y=g.width/e(".imgWrap").width();t=g.width/y/2-i;n=g.height/y/2-s;m.drawImage(g,0,0)};d.src=r;d.onload=function(){e("#imgEditor").show()}};this.getImgData=function(){return v.toDataURL()};e(".ok").click(function(){o=(g.width/y*p/2-t)/p*y;u=(g.height/y*p/2-n)/p*y;if(o<0||u<0||o+v.width*y/p>g.width||u+v.height*y/p>g.height){alert("头像没有充满选择区域");return}m.drawImage(g,o,u,v.width*y/p,v.height*y/p,0,0,v.width,v.height);e("#imgEditor").hide();e("#finishImg")[0].src=v.toDataURL();r.isReadyImg=!0});e(".close").click(function(){e("#imgEditor").hide()});touch.on(".eventReceiver","touchstart",function(e){e.originEvent.preventDefault();e.originEvent.stopPropagation()});touch.on(".eventReceiver","drag",{interval:10},function(e){l=a+e.distanceX;c=f+e.distanceY;if(e.fingerStatus==="end"){a+=e.distanceX;f+=e.distanceY;t+=e.distanceX;n+=e.distanceY}d.style.webkitTransform="translate3d("+l+"px,"+c+"px, 0px) "+"scale("+p+")"});touch.on(".eventReceiver","pinch",{interval:10},function(e){p=e.scale-1;p=h+p;if(e.fingerStatus==="end"){h+=e.scale-1;h=h>2.5?2.5:h;h=h<.5?.5:h}p=p>2.5?2.5:p;p=p<.5?.5:p;d.style.webkitTransform="translate3d("+l+"px,"+c+"px, 0px) "+"scale("+p+")"})}var t=new s,n=new XMLHttpRequest;n.open("post","postData.php",!0);n.timeout=6e4;n.onreadystatechange=function(){if(n.readyState===4&&n.status===200){var e=JSON.parse(n.responseText);if(e.result=="ok"){util.sucMsg("上传成功");setTimeout(function(){location.href="http://p.www.xiaomi.com/m/activities/open/46/130328/weibo.html?"+Math.round(Math.random()*1e4)},1e3)}else{util.hideLoad();util.sucMsg("上传失败，刷新后重新上传");setTimeout(function(){location.reload()},2e3)}}};n.onloadstart=function(){util.showLoad()};n.ontimeout=function(){alert("服务器请求超时了，换一张小点的图!");setTimeout(function(){location.reload()},1e3)};var r={clientId:180100031013,isLogin:!1,isRight:!1,isReadyImg:!1,uid:"",isAbility:!1,origin:"",queryUrl:"http://app.shopapi.xiaomi.com/v1/mfn/query?client_id=180100031013&user_id=",fileInput:e("#upload"),fileName:e("#name"),fileTel:e("#tel"),fileMiliao:e("#miliao"),fileBtn:e("#fileBtn"),upBtn:e("#upBtn"),edImg:e("#finishImg"),v:["jpg","png","jpeg"],init:function(){util.run();this.Login();if(!this.isLogin){alert("未登录小米商城");setTimeout(function(){util.goHome()},1e3)}this.isMay(function(e,t){if(e&&r.uid==t){util.isAbility()?r.isAbility=!0:r.isAbility=!1;r.isEdit(function(e,t){e&&r.reEdit(t.data)})}})},Login:function(){util.isLogin(function(e,t){if(e){r.uid=t;r.queryUrl=r.queryUrl+t;r.isLogin=!0}else r.isLogin=!1})},isMay:function(t){var n=!1;e.ajax({type:"get",url:"getPower.php?userId="+r.uid,success:function(e){var e=JSON.parse(e);if(e.result=="ok"){n=!0;t(n,e.userId)}else{n=!1;alert("没有购票资格");util.goHome()}},error:function(){alert("服务器压力上大，刷新重试");setTimeout(function(){location.reload()},1e3)}})},isEdit:function(t){var n=!1;e.ajax({type:"get",url:r.queryUrl,dataType:"jsonp",jsonp:"callback",success:function(e){if(e.result==="ok"){n=!0;t(n,e);location.href="http://p.www.xiaomi.com/m/activities/open/46/130328/weibo.html?"+Math.round(Math.random()*1e4)}else{n=!1;t(n)}},error:function(){alert("服务器压力上大，刷新重试");setTimeout(function(){location.reload()},1e3)}})},reEdit:function(e){var t,n,r,i;t=e.name;n=e.tel;r=e.miliaoid;i=e.image;this.fileName.val(t);this.fileTel.val(n);this.fileMiliao.val(r);this.edImg[0].src=i+"?"+Math.round(Math.random()*1e4)},okType:function(e){var t=e.name,n=!1;for(var r=0,i=this.v.length;r<i;r++)t.indexOf(this.v[r])>0&&(n=!0);return n},okSize:function(e){var t=e.size/1024;if(t>3072){alert("图片过大，建议换一张图片上传");return!1}return!0},okImg:function(e,t){var n;window.webkitURL?n=window.webkitURL.createObjectURL(e):window.URL&&(n=window.URL.createObjectURL(e));t(n)},vrForm:function(){if(this.fileName.val()==""){alert("请填写姓名");return!1}if(!util.IsTelephone(this.fileTel.val())){alert("请填写正确的手机号");return!1}if(this.isAbility){if(this.fileInput.val()==""||!this.isReadyImg){alert("请上传并编辑头像");return!1}}else if(this.fileInput.val()==""){alert("请上传头像");return!1}return!0},inData:function(e){var n,r;n=t.getImgData();r=new FormData;r.append("name",this.fileName.val());r.append("tel",this.fileTel.val());r.append("miliao",this.fileMiliao.val());r.append("img",n);r.append("originimage",this.origin);e(r)}};if(window.FileReader){var i=new FileReader;i.onload=function(e){var t=e.target.result;r.origin=t}}r.fileInput.on("change",function(){r.isReadyImg=!1;if(!r.okType(this.files[0])){alert("支持图片格式: jpg/jpeg/png");return}if(!r.okSize(this.files[0]))return;if(r.isAbility){r.okImg(this.files[0],function(e){t.show(e)});i.readAsDataURL(this.files[0])}else r.edImg[0].src="http://p.www.xiaomi.com/m/images/130327/defalt02.png"});r.upBtn.on("click",function(){if(!r.vrForm())return;if(r.isAbility)r.inData(function(e){n.send(e)});else{var t={type:"post",iframe:!0,beforeSubmit:function(){util.showLoad();return!0},success:function(){util.sucMsg("验证数据")},complete:function(e){var t=e.responseText;if(t.indexOf("error")==-1){util.sucMsg("上传成功");setTimeout(function(){location.href="http://p.www.xiaomi.com/m/activities/open/46/130328/weibo.html?"+Math.round(Math.random()*1e4)},1e3)}else{util.sucMsg("换张小图");setTimeout(function(){location.reload()},2e3)}}};e("#postFrom").on("submit",function(n){n.preventDefault();e(this).ajaxSubmit(t)});e("#postFrom").submit()}});r.edImg.on("click",function(){r.fileInput.trigger("click")});r.init()})})(jQuery);